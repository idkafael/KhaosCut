<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Leitor de Manga</title>

    <!-- Meta Pixel Code (4522116724777969) -->
    <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '4522116724777969');
    fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=4522116724777969&ev=PageView&noscript=1"
    /></noscript>
    <!-- End Meta Pixel Code -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #2a2a2a;
            color: #fff;
            overflow-x: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        .reader-header {
            background: #2a2a2a;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #3a3a3a;
            flex-shrink: 0;
            z-index: 100;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        
        .back-button {
            background: none;
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .header-title {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .header-title h1 {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            margin: 0;
            line-height: 1.2;
        }
        
        .header-title .episode {
            font-size: 12px;
            color: #ccc;
            font-weight: 400;
        }
        
        .header-logo {
            height: 32px;
            width: auto;
            flex-shrink: 0;
        }
        
        /* √Årea de Leitura */
        .reader-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            background: #1a1a1a;
            position: relative;
            -webkit-overflow-scrolling: touch;
        }
        
        .reader-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .reader-content::-webkit-scrollbar-track {
            background: #2a2a2a;
        }
        
        .reader-content::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 3px;
        }
        
        .reader-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        #manga-pages {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0;
            gap: 0;
        }
        
        .manga-page {
            width: 100%;
            display: flex;
            justify-content: center;
            background: #1a1a1a;
            padding: 0;
            margin: 0;
        }
        
        .manga-page img {
            width: 100%;
            height: auto;
            display: block;
            max-width: 100%;
            object-fit: contain;
        }
        
        /* Modal de Pagamento */
        .modal-v2 {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 99999;
            align-items: center;
            justify-content: center;
        }
        
        .modal-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            cursor: pointer;
        }
        
        .modal-v2-content {
            position: relative;
            background: #eaf3fb;
            border-radius: 12px;
            max-width: 450px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 100000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            cursor: pointer;
            z-index: 10;
            padding: 5px;
        }
        
        .modal-v2-body {
            position: relative;
        }
        
        .modal-v2-inner {
            padding: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .btn-payment:hover {
            background: #ffed4a;
        }
        
        .btn-payment:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Navega√ß√£o */
        .reader-nav {
            background: #2a2a2a;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #3a3a3a;
            flex-shrink: 0;
        }
        
        .nav-button {
            background: #3a3a3a;
            border: none;
            color: #fff;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-button:hover {
            background: #4a4a4a;
        }
        
        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #ccc;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #f44336;
        }
        
        @media (max-width: 768px) {
            .reader-header {
                padding: 10px 12px;
            }
            
            .header-title h1 {
                font-size: 14px;
            }
            
            .header-title .episode {
                font-size: 11px;
            }
            
            .reader-nav {
                padding: 10px 12px;
            }
            
            .nav-button {
                padding: 8px 16px;
                font-size: 13px;
            }
            
            .payment-modal-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="reader-header">
        <div class="header-left">
            <button class="back-button" onclick="goBack()" aria-label="Voltar">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <div class="header-title">
                <h1 id="story-title">Carregando...</h1>
                <span class="episode" id="episode-title">Epis√≥dio</span>
            </div>
        </div>
        <a href="index.html" style="display: flex; align-items: center;">
            <img src="images/logo-color.png" alt="Logo" class="header-logo" style="cursor: pointer;">
        </a>
    </header>
    
    <!-- √Årea de Leitura -->
    <div class="reader-content" id="reader-content">
        <div id="manga-pages">
            <div class="loading">Carregando p√°ginas...</div>
        </div>
    </div>
    
    <!-- Navega√ß√£o -->
    <nav class="reader-nav">
        <button class="nav-button" onclick="goToPreviousEpisode()" id="prev-episode">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Epis√≥dio Anterior
        </button>
        <button class="nav-button" onclick="goToNextEpisode()" id="next-episode">
            Pr√≥ximo Epis√≥dio
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    </nav>
    
    <!-- Modal de Pagamento -->
    <div class="modal-v2 modal-payment" id="payment-modal" style="display: none;">
        <div class="modal-bg modal-exit" onclick="closePaymentModal()"></div>
        <div class="modal-v2-content" style="max-width: 450px;">
            <span class="close close-modal modal-exit" onclick="closePaymentModal()">
                <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M7.00072 5.58672L11.9507 0.636719L13.3647 2.05072L8.41472 7.00072L13.3647 11.9507L11.9507 13.3647L7.00072 8.41472L2.05072 13.3647L0.636719 11.9507L5.58672 7.00072L0.636719 2.05072L2.05072 0.636719L7.00072 5.58672Z" fill="black"></path>
                </svg>
            </span>
            <div class="modal-v2-body">
                <div style="text-align: center; position: relative; border-radius: 12px 12px 0 0; overflow: hidden; width: 100%; margin: 0; padding: 0;">
                    <img src="images/ask-modal-bg.bf80a828.webp" alt="Leia de forma vital√≠cia" style="width: 100%; max-width: none; height: auto; display: block; object-fit: cover; margin: 0; padding: 0; border-radius: 12px 12px 0 0; min-height: 200px; object-position: center;">
                    <div style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); text-align: center; width: 100%; padding: 0 15px;">
                        <h2 class="modal-header-text" style="font-family: Impact, 'Arial Black', sans-serif; font-size: 24px; font-weight: 700; color: #000; margin: 0; text-transform: uppercase; letter-spacing: 1px; text-shadow: 2px 2px 4px rgba(255,255,255,0.8); line-height: 1.2;">LEIA DE FORMA ‚Äî</h2>
                        <h2 class="modal-header-text" style="font-family: Impact, 'Arial Black', sans-serif; font-size: 24px; font-weight: 700; color: #000; margin: 5px 0 0 0; text-transform: uppercase; letter-spacing: 1px; text-shadow: 2px 2px 4px rgba(255,255,255,0.8); line-height: 1.2;">VITAL√çCIA!</h2>
                    </div>
                </div>
                <div class="modal-v2-inner">
                    <div id="payment-loading" style="text-align: center; padding: 40px;">
                        <div style="display: inline-block; width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #ffdb26; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <p style="margin-top: 20px; color: #666;">Gerando QR Code...</p>
                    </div>
                    <div id="payment-content" style="display: none;">
                        <!-- Sele√ß√£o de Planos -->
                        <div style="margin-bottom: 20px;">
                            <p style="text-align: center; color: #000; font-weight: 700; margin: 0 0 15px 0; font-size: 16px;">ESCOLHA SEU PLANO</p>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <!-- Plano 1: Acesso Completo - R$ 19,90 (Padr√£o) -->
                                <div style="background: #fff; border: 2px solid #ffdb26; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(255, 219, 38, 0.3);" onclick="selectPaymentPlan('full', 19.90)" id="plan-full">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                        <div style="flex: 1;">
                                            <div style="color: #000; font-weight: 700; font-size: 16px; margin-bottom: 6px;">ACESSO COMPLETO</div>
                                            <div style="color: #666; font-size: 13px; margin-bottom: 8px; line-height: 1.4;">Libera TODAS as hist√≥rias do site, de forma vital√≠cia, em qualquer dispositivo.</div>
                                            <div style="color: #ff6b9d; font-weight: 700; font-size: 20px;">R$ 19,90</div>
                                        </div>
                                        <div id="check-full" style="color: #4caf50; font-size: 24px; margin-left: 10px; flex-shrink: 0;">‚úì</div>
                                    </div>
                                </div>
                                
                                <!-- Plano 2: Apenas Esta Hist√≥ria - R$ 9,90 -->
                                <div style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.2s;" onclick="selectPaymentPlan('single', 9.90)" id="plan-single">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                        <div style="flex: 1;">
                                            <div style="color: #000; font-weight: 700; font-size: 16px; margin-bottom: 6px;">APENAS ESTA HIST√ìRIA</div>
                                            <div style="color: #666; font-size: 13px; margin-bottom: 8px; line-height: 1.4;">Libera somente esta hist√≥ria que voc√™ est√° lendo, de forma vital√≠cia, sem liberar as outras.</div>
                                            <div style="color: #ff6b9d; font-weight: 700; font-size: 20px;">R$ 9,90</div>
                                        </div>
                                        <div id="check-single" style="color: #4caf50; font-size: 24px; margin-left: 10px; flex-shrink: 0; display: none;">‚úì</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-bottom: 15px;">
                            <div id="qrcode-container" style="display: inline-block; padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 100%; box-sizing: border-box;"></div>
                        </div>
                        <div style="text-align: center; margin-bottom: 15px;">
                            <p style="margin: 0 0 5px 0; font-weight: 600; color: #000; font-size: 14px;">Valor:</p>
                            <p id="payment-amount" style="font-size: 28px; font-weight: 700; color: #000; margin: 0;">R$ 0,00</p>
                        </div>
                        <div style="position: relative; text-align: center; margin: 20px 0;">
                            <div style="position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: #ddd;"></div>
                            <span style="position: relative; background: transparent; padding: 0 15px; color: #666; font-size: 14px;">ou</span>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #000; font-size: 14px;">C√≥digo Pix (Copiar e Colar):</label>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <input type="text" id="pix-code" readonly style="flex: 1; min-width: 200px; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; font-family: monospace; background: #fff; box-sizing: border-box;">
                                <button onclick="copyPixCode()" style="padding: 12px 20px; background: #ffdb26; color: #000; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; white-space: nowrap; flex-shrink: 0;">Copiar</button>
                            </div>
                        </div>
                        <div id="payment-status" style="text-align: center; padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #f5f5f5;">
                            <p style="margin: 0; color: #666; font-size: 14px;">Aguardando pagamento...</p>
                        </div>
                        
                        <button class="btn btn-yellow btn-yellow--big w-100" onclick="goBack()" style="background: #ffdb26; color: #000; font-weight: 700; padding: 14px 24px; border-radius: 8px; border: none; cursor: pointer; width: 100%; font-size: 16px; box-sizing: border-box;">
                            Voltar para o in√≠cio
                        </button>
                    </div>
                    <div id="payment-error" style="display: none; text-align: center; padding: 40px;">
                        <p style="color: #dc143c; font-weight: 600; margin-bottom: 20px;">Erro ao gerar pagamento</p>
                        <button class="btn btn-yellow btn-yellow--big" onclick="retryPayment()" style="background: #ffdb26; color: #000; font-weight: 700; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer;">
                            Tentar Novamente
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Configura√ß√£o
        let currentComic = null;
        let currentEpisode = null;
        let comicsConfig = null;
        let episodeImages = [];
        
        // Configura√ß√£o PushinPay
        const PushinPayConfig = {
            apiBaseUrl: 'https://api.pushinpay.com.br/api',
            apiToken: '60917|m4kT6SITcItBgEIAnYZ0Q6NBnbxpRlIJWZeBaQ3L46ffe607',
            valor: 19.90,
            plano: 'Acesso Premium'
        };
        
        let paymentCheckInterval = null;
        let currentTransactionId = null;
        let currentPixCode = null;
        
        // Fun√ß√£o para obter par√¢metros da URL
        function getUrlParams() {
            const path = window.location.pathname;
            const parts = path.split('/').filter(p => p);
            
            // Formato esperado: /comic1/episode1 ou /comic1/episode1.html
            let comicId = null;
            let episodeNum = null;
            
            // Primeiro tentar ler do path
            if (parts.length >= 2) {
                const comicPart = parts[0];
                const episodePart = parts[1];
                
                // Extrair n√∫mero do comic (comic1 -> 1)
                const comicMatch = comicPart.match(/comic(\d+)/i);
                if (comicMatch) {
                    comicId = `comic${comicMatch[1]}`;
                } else {
                    comicId = comicPart;
                }
                
                // Extrair n√∫mero do epis√≥dio (episode1 -> 1)
                const episodeMatch = episodePart.match(/episode(\d+)/i);
                if (episodeMatch) {
                    episodeNum = parseInt(episodeMatch[1]);
                } else {
                    episodeNum = parseInt(episodePart.replace('.html', ''));
                }
            } else {
                // Tentar parsear se vier como query string (fallback do rewrite)
                const urlParams = new URLSearchParams(window.location.search);
                const comicParam = urlParams.get('comic');
                const episodeParam = urlParams.get('episode');
                
                if (comicParam) {
                    const comicMatch = comicParam.match(/comic(\d+)/i);
                    comicId = comicMatch ? `comic${comicMatch[1]}` : comicParam;
                }
                
                if (episodeParam) {
                    episodeNum = parseInt(episodeParam);
                }
            }
            
            return {
                comic: comicId,
                episode: episodeNum
            };
        }
        
        // Carregar configura√ß√£o
        async function loadConfig() {
            try {
                // Adicionar timestamp para evitar cache
                console.log('üì• Fazendo fetch de comics-config.json...');
                const response = await fetch('comics-config.json?v=' + Date.now());
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                comicsConfig = await response.json();
                console.log('‚úÖ JSON carregado com sucesso');
                
                // Validar e limpar caminhos absolutos se houver
                if (comicsConfig && comicsConfig.stories) {
                    comicsConfig.stories.forEach(story => {
                        if (story.episodes) {
                            story.episodes.forEach(episode => {
                                if (episode.images) {
                                    episode.images = episode.images.map(imgPath => {
                                        // Remover qualquer caminho absoluto do Windows
                                        if (imgPath.includes('C:/') || imgPath.includes('C:\\')) {
                                            const imagesIndex = imgPath.indexOf('images/');
                                            if (imagesIndex !== -1) {
                                                return imgPath.substring(imagesIndex);
                                            }
                                        }
                                        return imgPath;
                                    });
                                }
                            });
                        }
                    });
                }
                
                return comicsConfig;
            } catch (error) {
                console.error('Erro ao carregar configura√ß√£o:', error);
                return null;
            }
        }
        
        // Carregar lista de imagens do epis√≥dio
        async function loadEpisodeImages(comicId, episodeNum) {
            const story = comicsConfig.stories.find(s => s.id === comicId);
            if (!story) {
                throw new Error('Hist√≥ria n√£o encontrada');
            }
            
            const episode = story.episodes.find(e => e.number === episodeNum);
            if (!episode) {
                throw new Error('Epis√≥dio n√£o encontrado');
            }
            
            // Buscar todas as imagens .webp na pasta do epis√≥dio
            const imagesPath = episode.imagesPath;
            const images = [];
            
            // Como n√£o temos acesso ao filesystem no browser, vamos tentar carregar as imagens
            // baseado no padr√£o de nomenclatura que vimos
            for (let i = 2; i <= episode.totalPages + 1; i++) {
                // Tentar diferentes padr√µes de nome
                const patterns = [
                    `${imagesPath}/imgi_${i}_`,
                    `${imagesPath}/imgi_${String(i).padStart(2, '0')}_`,
                    `${imagesPath}/page_${i}.webp`,
                    `${imagesPath}/${i}.webp`
                ];
                
                // Vamos usar uma abordagem diferente: fazer uma requisi√ß√£o para uma API que lista os arquivos
                // Por enquanto, vamos usar o padr√£o que vimos nos arquivos existentes
                const baseUrl = `${imagesPath}/imgi_${i}_`;
                images.push(baseUrl);
            }
            
            // Alternativa: usar um endpoint que lista os arquivos ou carregar de um JSON pr√©-gerado
            // Por enquanto, vamos usar uma lista hardcoded baseada no que vimos
            return getHardcodedImages(comicId, episodeNum);
        }
        
        // Fun√ß√£o tempor√°ria para obter imagens hardcoded
        function getHardcodedImages(comicId, episodeNum) {
            // Baseado no que vimos no arquivo read-episodio-1-ensinameprimeiro.html
            if (comicId === 'comic1' && episodeNum === 1) {
                const basePath = 'images/comic1/episode 1';
                const images = [];
                // Lista completa das imagens do epis√≥dio 1
                const imageFiles = [
                    'imgi_2_7ad8ef3f-7c84-48e4-8307-8a89b4266317-1756976552-48.webp',
                    'imgi_3_4214d2a4-1d7a-4581-a6a1-4628008dcdf2-1756976552-21.webp',
                    'imgi_4_85ab3fd5-9284-47a5-b73f-cf08b0edd4c7-1756976552-51.webp',
                    'imgi_5_0599a477-1e21-4999-8ccb-337bf2792ce4-1756976552-11.webp',
                    'imgi_6_8f15bc01-7539-483d-a26d-64b9dc47396a-1756976552-36.webp',
                    'imgi_7_fa501b87-2011-442c-bd71-9b2bed34067b-1756976552-30.webp',
                    'imgi_8_ed332c2f-3d97-405b-9981-e6fcfe1cd98a-1756976552-58.webp',
                    'imgi_9_a3b3c8d9-116c-4e48-82da-ddf6a6f307b2-1756976552-88.webp',
                    'imgi_10_09fe8041-2a4b-48d2-a42e-12f34cf1f1cb-1756976552-61.webp',
                    'imgi_11_ac3b6057-ca83-4658-927f-5477d0d826fe-1756976553-23.webp',
                    'imgi_12_d529b815-ea1c-43b9-8f3e-bd1246d13682-1756976553-14.webp',
                    'imgi_13_d72908d8-38b9-4e2f-9302-45ffc9b4956c-1756976553-43.webp',
                    'imgi_14_940ac8b5-cb2d-4196-bc17-c9aaf57aafb9-1756976553-85.webp',
                    'imgi_15_a992bd21-15dc-42c7-8ecf-1b069d7a07ef-1756976553-35.webp',
                    'imgi_16_534edfd4-d1bd-40b5-84e8-9aa98a6647aa-1756976553-53.webp',
                    'imgi_17_f490d980-c09c-4f80-a3ed-0bb4ff804f3d-1756976553-94.webp',
                    'imgi_18_66b6ec69-8379-4fc1-8434-133d7102916f-1756976553-72.webp',
                    'imgi_19_914590f9-6d93-4fa2-8820-f17973918559-1756976553-48.webp',
                    'imgi_20_41141717-59c3-4197-b973-6c5b7a1c03ac-1756976553-57.webp',
                    'imgi_21_92947b62-4136-4f23-9fd5-900383f8540b-1756976553-93.webp',
                    'imgi_22_4728a78a-d39d-4634-86b2-357d0ddfdcaa-1756976553-57.webp',
                    'imgi_23_30d54596-ac6d-47ac-997f-3973a2fccbd7-1756976553-23.webp',
                    'imgi_24_cd509e4b-fef6-44ae-a42d-bf5a045c6a1b-1756976553-69.webp',
                    'imgi_25_c58004de-9fcd-4e3c-9de6-292a87837c71-1756976553-38.webp',
                    'imgi_26_d0237d75-c866-48af-8efa-b0d647a8512e-1756976553-69.webp',
                    'imgi_27_24a1e3fb-edfb-4eae-b7e7-02d111750a34-1756976553-67.webp',
                    'imgi_28_1dab3473-1d72-4ebe-97e3-4087f1e851fb-1756976553-57.webp',
                    'imgi_29_e23f7c5e-4da1-4d76-9f4f-8dda07d5911f-1756976553-36.webp',
                    'imgi_30_e25c32a1-bd8d-4965-aff9-7c2cfb4c20a3-1756976554-66.webp',
                    'imgi_31_38625298-9b85-4dec-a1b9-6cd921846086-1756976554-22.webp',
                    'imgi_32_e955f7f5-31a3-4898-897e-5a0b376773c6-1756976554-27.webp',
                    'imgi_33_dbec3b32-6216-47b1-9092-0ca062dab07a-1756976554-61.webp',
                    'imgi_34_a56d39cc-ac9c-4ee2-9c73-94594c988409-1756976554-32.webp',
                    'imgi_35_fd4cd5aa-692e-4f7b-9bdc-45789deda776-1756976554-22.webp',
                    'imgi_36_a5a561ec-4079-403c-8cf9-efe5928228b8-1756976554-92.webp',
                    'imgi_37_afa97cd6-c062-4f6a-af58-d178d1676be2-1756976554-46.webp',
                    'imgi_38_c5b640b5-349f-45c8-8923-3e0ef4453fb3-1756976554-56.webp',
                    'imgi_39_51429d2e-46f8-4cac-941b-104fbcac35ef-1756976554-20.webp',
                    'imgi_40_1a2fc159-4938-4dab-9b43-b24afd5a6127-1756976554-38.webp',
                    'imgi_41_df817936-9a83-4d21-ad3a-1b2d710bf7f3-1756976554-48.webp',
                    'imgi_42_5b8d27a7-1761-48f9-8efb-02a359b3df93-1756976554-46.webp',
                    'imgi_43_bac825bc-feca-406b-84af-6f1b45903a59-1756976554-51.webp',
                    'imgi_44_364f5bc9-d250-4b4f-b778-2c86d7bdc33a-1756976554-25.webp',
                    'imgi_45_395b9c65-5c4a-43a3-8279-74aa515b7371-1756976554-65.webp',
                    'imgi_46_ca8dd4eb-594c-4a2c-ba8c-122a18771e44-1756976554-67.webp',
                    'imgi_47_dc39ac12-b3dc-43c9-842e-0a8e56ea5db3-1756976554-44.webp',
                    'imgi_48_ec781ce6-0e37-4766-8691-6b4e37b29670-1756976554-95.webp',
                    'imgi_49_1d3750ee-c9de-4653-adec-5377e279d142-1756976554-44.webp',
                    'imgi_50_3e98783f-10e7-4159-8b4c-77130944b82b-1756976554-23.webp',
                    'imgi_51_1d014d30-be3f-4356-9459-56c07f51b1ef-1756976555-57.webp',
                    'imgi_52_7c4e57c7-ee19-4f94-af35-eb59d3f0b017-1756976555-94.webp',
                    'imgi_53_c4e1785f-62f7-48ea-b26b-dc15573ea2d2-1756976555-81.webp'
                ];
                
                return imageFiles.map(file => `${basePath}/${file}`);
            }
            
            // Para outros epis√≥dios, retornar array vazio (ser√° implementado depois)
            return [];
        }
        
        // Carregar e exibir p√°ginas
        async function loadMangaPages() {
            const container = document.getElementById('manga-pages');
            container.innerHTML = '<div class="loading">Carregando p√°ginas...</div>';
            
            try {
                const params = getUrlParams();
                console.log('üìñ Par√¢metros da URL:', params);
                if (!params.comic || !params.episode) {
                    throw new Error('Par√¢metros inv√°lidos na URL');
                }
                
                currentComic = params.comic;
                currentEpisode = params.episode;
                
                // Carregar configura√ß√£o
                console.log('üìã Carregando configura√ß√£o...');
                await loadConfig();
                if (!comicsConfig) {
                    throw new Error('N√£o foi poss√≠vel carregar a configura√ß√£o');
                }
                console.log('‚úÖ Configura√ß√£o carregada:', comicsConfig);
                
                const story = comicsConfig.stories.find(s => s.id === currentComic);
                if (!story) {
                    console.error('‚ùå Hist√≥ria n√£o encontrada:', currentComic);
                    throw new Error('Hist√≥ria n√£o encontrada');
                }
                console.log('‚úÖ Hist√≥ria encontrada:', story.name);
                
                const episode = story.episodes.find(e => e.number === currentEpisode);
                if (!episode) {
                    console.error('‚ùå Epis√≥dio n√£o encontrado:', currentEpisode);
                    throw new Error('Epis√≥dio n√£o encontrado');
                }
                console.log('‚úÖ Epis√≥dio encontrado:', episode.number, '- Imagens:', episode.images?.length || 0);
                
                // Atualizar t√≠tulo
                document.getElementById('story-title').textContent = story.name;
                document.getElementById('episode-title').textContent = `Epis√≥dio ${currentEpisode}`;
                
                // Verificar se requer pagamento e se j√° foi pago
                // Epis√≥dio 3 √© TOTALMENTE ACESS√çVEL - modal aparece apenas ao final
                // Epis√≥dios 4+ s√£o bloqueados at√© pagamento
                const requiresPayment = currentEpisode > 3; // Apenas epis√≥dios ap√≥s o 3¬∫ requerem pagamento para acessar
                const hasPayment = checkPaymentStatus();
                
                if (requiresPayment && !hasPayment) {
                    // Bloquear acesso apenas para epis√≥dios 4+
                    container.innerHTML = '<div class="loading">Este epis√≥dio requer assinatura premium</div>';
                    showPaymentModal();
                    return;
                }
                
                // Epis√≥dio 3 √© totalmente acess√≠vel - carregar todas as imagens normalmente
                // O modal aparecer√° automaticamente ao chegar no final (configurado abaixo)
                
                // Carregar imagens do JSON
                if (episode.images && episode.images.length > 0) {
                    // Processar caminhos das imagens
                    episodeImages = episode.images.map(imgPath => {
                        // Limpar caminho - remover qualquer caminho absoluto
                        let cleanPath = imgPath.trim();
                        
                        // Se contiver caminho absoluto do Windows, extrair apenas a parte relativa
                        if (cleanPath.includes('C:/') || cleanPath.includes('C:\\')) {
                            const imagesIndex = cleanPath.indexOf('images/');
                            if (imagesIndex !== -1) {
                                cleanPath = cleanPath.substring(imagesIndex);
                            } else {
                                console.warn('Caminho absoluto sem "images/":', cleanPath);
                                return null;
                            }
                        }
                        
                        // Garantir que comece com /
                        if (!cleanPath.startsWith('/')) {
                            cleanPath = '/' + cleanPath;
                        }
                        
                        // Codificar apenas os espa√ßos e caracteres especiais nas partes do caminho
                        const parts = cleanPath.split('/');
                        const encodedParts = parts.map((part, index) => {
                            if (index === 0 || part === '') return part;
                            return encodeURIComponent(part);
                        });
                        
                        return encodedParts.join('/');
                    }).filter(path => path !== null); // Remover nulls
                    
                    console.log('üì∏ Total de imagens:', episodeImages.length);
                    console.log('üì∏ Primeira URL processada:', episodeImages[0]);
                } else {
                    // Fallback para fun√ß√£o hardcoded
                    episodeImages = await getHardcodedImages(currentComic, currentEpisode);
                }
                
                if (!episodeImages || episodeImages.length === 0) {
                    console.error('‚ùå Nenhuma imagem encontrada. episodeImages:', episodeImages);
                    throw new Error('Nenhuma imagem encontrada para este epis√≥dio');
                }
                
                // Renderizar p√°ginas
                container.innerHTML = '';
                console.log('üì∏ Total de imagens para carregar:', episodeImages.length);
                console.log('üì∏ Primeiras 3 URLs:', episodeImages.slice(0, 3));
                
                if (episodeImages.length === 0) {
                    throw new Error('Array de imagens est√° vazio ap√≥s processamento');
                }
                
                episodeImages.forEach((url, index) => {
                    const pageDiv = document.createElement('div');
                    pageDiv.className = 'manga-page';
                    const img = document.createElement('img');
                    
                    // Usar a URL j√° processada (j√° vem com / no in√≠cio e codificada)
                    img.src = url;
                    img.alt = `P√°gina ${index + 1}`;
                    img.loading = index < 3 ? 'eager' : 'lazy';
                    
                    // Estilos inline para garantir exibi√ß√£o correta
                    img.style.width = '100%';
                    img.style.height = 'auto';
                    img.style.display = 'block';
                    img.style.maxWidth = '100%';
                    img.style.objectFit = 'contain';
                    
                    // Flag para evitar loop de tentativas
                    let errorHandled = false;
                    
                    img.onload = function() {
                        if (index < 3) {
                            console.log(`‚úÖ Imagem ${index + 1} carregada:`, url);
                        }
                    };
                    
                    img.onerror = function() {
                        if (!errorHandled) {
                            errorHandled = true;
                            console.error(`‚ùå Erro ao carregar p√°gina ${index + 1}:`, url);
                            
                            // Tentar apenas uma vez com caminho sem codifica√ß√£o (para espa√ßos)
                            const decodedUrl = decodeURIComponent(url);
                            if (decodedUrl !== url) {
                                console.log(`üîÑ Tentando URL decodificada:`, decodedUrl);
                                this.src = decodedUrl;
                                return;
                            }
                            
                            // Se falhar, mostrar placeholder est√°tico (sem loop)
                            this.style.display = 'none';
                            const errorDiv = document.createElement('div');
                            errorDiv.style.cssText = 'padding: 40px; text-align: center; color: #666; min-height: 200px; display: flex; align-items: center; justify-content: center;';
                            errorDiv.textContent = `Erro ao carregar p√°gina ${index + 1}`;
                            pageDiv.appendChild(errorDiv);
                        }
                    };
                    
                    pageDiv.appendChild(img);
                    container.appendChild(pageDiv);
                });
                
                // Configurar navega√ß√£o
                setupNavigation(story, currentEpisode);
                
                // Se estiver no epis√≥dio 3, adicionar listener para mostrar modal ao chegar no final
                if (currentEpisode === 3 && !checkPaymentStatus()) {
                    setupPaymentModalOnScroll();
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar p√°ginas:', error);
                container.innerHTML = `<div class="error-message" style="padding: 40px; text-align: center; color: #f44336;">
                    <h3>Erro ao carregar epis√≥dio</h3>
                    <p>${error.message}</p>
                    <p style="font-size: 12px; color: #666; margin-top: 20px;">Verifique o console para mais detalhes.</p>
                </div>`;
            }
        }
        
        // Configurar modal de pagamento ao chegar no final do epis√≥dio 3
        function setupPaymentModalOnScroll() {
            const readerContent = document.getElementById('reader-content');
            let modalShown = false;
            
            const checkScroll = () => {
                if (modalShown) return;
                
                // Verificar se chegou no final (95% do scroll ou menos de 100px do final)
                const scrollTop = readerContent.scrollTop;
                const scrollHeight = readerContent.scrollHeight;
                const clientHeight = readerContent.clientHeight;
                const scrollBottom = scrollHeight - scrollTop - clientHeight;
                
                // Se est√° a menos de 100px do final ou chegou a 95% do scroll
                if (scrollBottom <= 100 || (scrollTop + clientHeight) / scrollHeight >= 0.95) {
                    modalShown = true;
                    // Pequeno delay para melhor UX
                    setTimeout(() => {
                        if (!checkPaymentStatus()) {
                            console.log('üéØ Mostrando modal de pagamento ao final do epis√≥dio 3');
                            showPaymentModal();
                        }
                    }, 1000);
                }
            };
            
            // Listener de scroll
            readerContent.addEventListener('scroll', checkScroll, { passive: true });
            
            // Verificar quando as imagens carregarem (aguardar um pouco para garantir que todas carregaram)
            setTimeout(() => {
                checkScroll();
                // Verificar periodicamente tamb√©m (caso o scroll n√£o seja detectado)
                const intervalId = setInterval(() => {
                    checkScroll();
                    if (modalShown) {
                        clearInterval(intervalId);
                    }
                }, 500);
            }, 2000);
        }
        
        // Configurar navega√ß√£o
        function setupNavigation(story, episodeNum) {
            const episodes = story.episodes.filter(e => e.available);
            const currentIndex = episodes.findIndex(e => e.number === episodeNum);
            
            const prevBtn = document.getElementById('prev-episode');
            const nextBtn = document.getElementById('next-episode');
            
            if (currentIndex <= 0) {
                prevBtn.disabled = true;
            } else {
                prevBtn.disabled = false;
            }
            
            if (currentIndex >= episodes.length - 1) {
                nextBtn.disabled = true;
            } else {
                nextBtn.disabled = false;
            }
        }
        
        // Navega√ß√£o
        function goBack() {
            window.scrollTo(0, 0);
            window.location.href = 'index.html';
        }
        
        function goToPreviousEpisode() {
            if (!currentComic || !currentEpisode) return;
            const story = comicsConfig.stories.find(s => s.id === currentComic);
            if (!story) return;
            
            const episodes = story.episodes.filter(e => e.available);
            const currentIndex = episodes.findIndex(e => e.number === currentEpisode);
            
            if (currentIndex > 0) {
                const prevEpisode = episodes[currentIndex - 1];
                window.scrollTo(0, 0);
                // Usar estrutura de pastas se dispon√≠vel, sen√£o usar query string
                const path = window.location.pathname;
                if (path.includes('/comic') && path.includes('/episode')) {
                    window.location.href = `/${currentComic}/episode${prevEpisode.number}`;
                } else {
                    window.location.href = `viewer.html?comic=${currentComic}&episode=${prevEpisode.number}`;
                }
            }
        }
        
        function goToNextEpisode() {
            if (!currentComic || !currentEpisode) return;
            const story = comicsConfig.stories.find(s => s.id === currentComic);
            if (!story) return;
            
            const episodes = story.episodes.filter(e => e.available);
            const currentIndex = episodes.findIndex(e => e.number === currentEpisode);
            
            if (currentIndex < episodes.length - 1) {
                const nextEpisode = episodes[currentIndex + 1];
                
                // Se o pr√≥ximo epis√≥dio √© 4 ou superior e ainda n√£o foi pago, bloquear e mostrar modal
                if (nextEpisode.number > 3 && !checkPaymentStatus()) {
                    showPaymentModal();
                    return;
                }
                
                window.scrollTo(0, 0);
                // Usar estrutura de pastas se dispon√≠vel, sen√£o usar query string
                const path = window.location.pathname;
                if (path.includes('/comic') && path.includes('/episode')) {
                    window.location.href = `/${currentComic}/episode${nextEpisode.number}`;
                } else {
                    window.location.href = `viewer.html?comic=${currentComic}&episode=${nextEpisode.number}`;
                }
            } else {
                // Se est√° no √∫ltimo epis√≥dio dispon√≠vel (epis√≥dio 3) e n√£o pagou, mostrar modal
                if (currentEpisode === 3 && !checkPaymentStatus()) {
                    showPaymentModal();
                }
            }
        }
        
        // Verificar status de pagamento
        function checkPaymentStatus() {
            try {
                const paymentData = localStorage.getItem('pagamento_confirmado');
                if (!paymentData) return false;
                
                const payment = JSON.parse(paymentData);
                const isPaid = payment.status === 'paid' || payment.status === 'approved' || payment.status === 'confirmed';
                
                if (!isPaid) return false;
                
                // Se for acesso completo, libera tudo
                if (payment.scope === 'full') {
                    return true;
                }
                
                // Se for acesso single, verificar se √© o mesmo comic
                if (payment.scope === 'single' && payment.comicId) {
                    return payment.comicId === currentComic;
                }
                
                // Fallback: se n√£o tiver scope definido, considerar como acesso completo (compatibilidade)
                return true;
            } catch (error) {
                return false;
            }
        }
        
        // Fun√ß√£o para gerar QR Code visual a partir do c√≥digo PIX
        function generateQRCodeImage(pixCode) {
            if (!pixCode) return;
            const container = document.getElementById('qrcode-container');
            if (!container) return;
            container.innerHTML = '';
            const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(pixCode)}`;
            const img = document.createElement('img');
            img.src = qrCodeUrl;
            img.alt = 'QR Code Pix';
            img.style.maxWidth = '100%';
            img.style.height = 'auto';
            img.style.display = 'block';
            img.style.margin = '0 auto';
            img.style.borderRadius = '8px';
            container.appendChild(img);
        }

        // Fun√ß√£o para exibir QR Code base64
        function displayQRCodeBase64(qrCodeBase64) {
            if (!qrCodeBase64) return;
            const container = document.getElementById('qrcode-container');
            if (!container) return;
            container.innerHTML = '';
            const img = document.createElement('img');
            let imageSrc = qrCodeBase64;
            if (!qrCodeBase64.startsWith('data:')) {
                imageSrc = `data:image/png;base64,${qrCodeBase64}`;
            }
            img.src = imageSrc;
            img.alt = 'QR Code PIX';
            img.style.maxWidth = '100%';
            img.style.height = 'auto';
            img.style.display = 'block';
            img.style.margin = '0 auto';
            img.style.borderRadius = '8px';
            container.appendChild(img);
        }

        // Fun√ß√£o para criar pagamento PIX via PushinPay
        async function createPixPayment() {
            try {
                // Usar o valor do plano selecionado
                const valorFinal = selectedPaymentPrice;
                
                const valorEmCentavos = Math.round(valorFinal * 100);
                const response = await fetch(`${PushinPayConfig.apiBaseUrl}/pix/cashIn`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${PushinPayConfig.apiToken}`,
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ value: valorEmCentavos })
                });

                if (!response.ok) {
                    throw new Error(`Erro ao criar pagamento: ${response.status}`);
                }

                const data = await response.json();
                const pixCode = data.qr_code;
                const qrCodeBase64 = data.qr_code_base64;
                const transactionId = data.id;

                // Atualizar valor no modal (j√° foi atualizado pela fun√ß√£o updatePaymentAmount)
                // N√£o precisa atualizar aqui novamente

                // Exibir QR Code
                if (qrCodeBase64) {
                    displayQRCodeBase64(qrCodeBase64);
                } else if (pixCode) {
                    generateQRCodeImage(pixCode);
                }

                // Exibir c√≥digo PIX
                const pixCodeInput = document.getElementById('pix-code');
                if (pixCodeInput && pixCode) {
                    pixCodeInput.value = pixCode;
                    currentPixCode = pixCode;
                }

                // Salvar transaction ID e iniciar verifica√ß√£o
                if (transactionId) {
                    currentTransactionId = transactionId;
                    startPaymentCheck(transactionId);
                }
                
                // Mostrar conte√∫do
                const loading = document.getElementById('payment-loading');
                const content = document.getElementById('payment-content');
                const error = document.getElementById('payment-error');
                
                if (loading) loading.style.display = 'none';
                if (content) content.style.display = 'block';
                if (error) error.style.display = 'none';

                return data;
            } catch (error) {
                console.error('‚ùå Erro ao criar pagamento:', error);
                throw error;
            }
        }

        // Fun√ß√£o para verificar status do pagamento
        async function checkPaymentStatusAPI(transactionId) {
            try {
                const response = await fetch(`${PushinPayConfig.apiBaseUrl}/transactions/${transactionId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${PushinPayConfig.apiToken}`,
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    if (response.status === 404) return null;
                    throw new Error(`Erro ao verificar pagamento: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('‚ùå Erro ao verificar status:', error);
                return null;
            }
        }

        // Fun√ß√£o para iniciar verifica√ß√£o autom√°tica
        function startPaymentCheck(transactionId) {
            if (paymentCheckInterval) {
                clearInterval(paymentCheckInterval);
            }

            let tentativas = 0;
            const maxTentativas = 300;

            const verificarPagamento = async () => {
                tentativas++;
                if (tentativas > maxTentativas) {
                    stopPaymentCheck();
                    updatePaymentStatus('‚è±Ô∏è Tempo de verifica√ß√£o expirado. Gere um novo QR Code.', true);
                    return;
                }

                const statusData = await checkPaymentStatusAPI(transactionId);
                if (!statusData) return;

                const status = statusData.status?.toLowerCase() || 'pending';
                if (status === 'paid' || status === 'approved' || status === 'confirmed') {
                    stopPaymentCheck();
                    updatePaymentStatus('‚úÖ Pagamento confirmado! Liberando acesso...', false, true);
                    try {
                        const paymentData = {
                            transactionId: transactionId,
                            status: status,
                            value: selectedPaymentPrice,
                            timestamp: new Date().toISOString(),
                            plano: selectedPaymentPlan === 'full' ? 'Acesso Completo' : 'Apenas Esta Hist√≥ria',
                            scope: selectedPaymentPlan, // 'full' ou 'single'
                            comicId: selectedPaymentPlan === 'single' ? currentComic : null // Salvar ID do comic se for plano single
                        };
                        localStorage.setItem('pagamento_confirmado', JSON.stringify(paymentData));
                        console.log('‚úÖ Pagamento salvo:', paymentData);
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Erro ao salvar no localStorage:', error);
                    }

                    // Disparar evento de compra no Meta Pixel
                    if (typeof fbq === 'function') {
                        try {
                            fbq('track', 'Purchase', {
                                value: selectedPaymentPrice,
                                currency: 'BRL',
                                contents: [{
                                    id: selectedPaymentPlan === 'full' ? 'full_access' : `single_${currentComic || 'comic'}`,
                                    quantity: 1
                                }],
                                content_type: 'product',
                                num_items: 1
                            });
                            console.log('‚úÖ Evento Purchase enviado para o Meta Pixel');
                        } catch (e) {
                            console.warn('‚ö†Ô∏è Erro ao enviar Purchase para o Meta Pixel:', e);
                        }
                    }

                    setTimeout(() => {
                        alert('Pagamento confirmado! Acesso liberado.');
                        location.reload();
                    }, 2000);
                } else if (status === 'canceled' || status === 'cancelled') {
                    stopPaymentCheck();
                    updatePaymentStatus('‚ùå Pagamento cancelado. Gere um novo QR Code.', true);
                } else {
                    updatePaymentStatus('Aguardando pagamento...', false);
                }
            };

            verificarPagamento();
            paymentCheckInterval = setInterval(verificarPagamento, 3000);
        }
        
        function stopPaymentCheck() {
            if (paymentCheckInterval) {
                clearInterval(paymentCheckInterval);
                paymentCheckInterval = null;
            }
        }

        function updatePaymentStatus(message, isError = false, isSuccess = false) {
            const statusDiv = document.getElementById('payment-status');
            if (!statusDiv) return;
            if (isSuccess) {
                statusDiv.style.background = '#4caf50';
                statusDiv.style.color = '#fff';
                statusDiv.innerHTML = `<p style="margin: 0; font-weight: 600;">${message}</p>`;
            } else if (isError) {
                statusDiv.style.background = '#dc143c';
                statusDiv.style.color = '#fff';
                statusDiv.innerHTML = `<p style="margin: 0; font-weight: 600;">${message}</p>`;
            } else {
                statusDiv.style.background = '#f5f5f5';
                statusDiv.style.color = '#666';
                statusDiv.innerHTML = `<p style="margin: 0;">${message}</p>`;
            }
        }

        // Fun√ß√£o para abrir modal de pagamento
        async function showPaymentModal() {
            try {
                const modal = document.getElementById('payment-modal');
                if (!modal) {
                    console.error('‚ùå Modal de pagamento n√£o encontrado no DOM');
                    return;
                }
            
            modal.style.cssText = `
                display: flex !important;
                z-index: 99999 !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background: rgba(0, 0, 0, 0.7) !important;
                visibility: visible !important;
                opacity: 1 !important;
                pointer-events: auto !important;
            `;
            
            const modalContent = modal.querySelector('.modal-v2-content');
            if (modalContent) {
                modalContent.style.cssText = `
                    background: #eaf3fb !important;
                    z-index: 100000 !important;
                    position: relative !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    display: block !important;
                `;
            }
            
            // Limpar QR Code anterior
            const qrContainer = document.getElementById('qrcode-container');
            if (qrContainer) qrContainer.innerHTML = '';
            
            // Limpar c√≥digo PIX anterior
            const pixInput = document.getElementById('pix-code');
            if (pixInput) pixInput.value = '';
            
            // Mostrar loading inicialmente
            const loading = document.getElementById('payment-loading');
            const content = document.getElementById('payment-content');
            const error = document.getElementById('payment-error');
            
            if (loading) loading.style.display = 'block';
            if (content) content.style.display = 'none';
            if (error) error.style.display = 'none';

            stopPaymentCheck();
            currentTransactionId = null;
            updatePaymentStatus('Gerando QR Code...', false);
            
            // Inicializar planos de pagamento (Acesso Completo selecionado por padr√£o)
            setTimeout(() => {
                initPaymentPlans();
            }, 100);

                try {
                    await createPixPayment();
                } catch (paymentError) {
                    console.error('‚ùå Erro ao processar pagamento:', paymentError);
                    if (loading) loading.style.display = 'none';
                    if (error) {
                        error.style.display = 'block';
                        const errorText = error.querySelector('p');
                        if (errorText) {
                            errorText.textContent = 'Erro ao gerar pagamento. Por favor, tente novamente.';
                        }
                    }
                }
            } catch (error) {
                console.error('‚ùå Erro ao abrir modal de pagamento:', error);
            }
        }
        
        function closePaymentModal() {
            const modal = document.getElementById('payment-modal');
            if (modal) {
                modal.style.display = 'none';
            }
            stopPaymentCheck();
        }
        
        function copyPixCode() {
            const pixCodeInput = document.getElementById('pix-code');
            if (pixCodeInput && pixCodeInput.value) {
                pixCodeInput.select();
                document.execCommand('copy');
                const button = event.target;
                if (button) {
                    const originalText = button.textContent;
                    button.textContent = 'Copiado!';
                    button.style.background = '#4caf50';
                    button.style.color = '#fff';
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.background = '#ffdb26';
                        button.style.color = '#000';
                    }, 2000);
                }
            }
        }
        
        function retryPayment() {
            showPaymentModal();
        }
        
        // Sele√ß√£o de Planos de Pagamento
        let selectedPaymentPlan = 'full'; // 'full' ou 'single'
        let selectedPaymentPrice = 19.90; // Pre√ßo padr√£o (Acesso Completo)
        
        // Fun√ß√£o para selecionar plano de pagamento
        function selectPaymentPlan(planType, price) {
            // N√£o permitir deselecionar - sempre deve ter um plano selecionado
            // Se clicar no mesmo plano, n√£o fazer nada
            if (selectedPaymentPlan === planType) {
                return;
            }
            
            // Remover sele√ß√£o anterior
            const prevPlanEl = document.getElementById(`plan-${selectedPaymentPlan}`);
            const prevCheckEl = document.getElementById(`check-${selectedPaymentPlan}`);
            if (prevPlanEl) {
                prevPlanEl.style.border = '1px solid #ddd';
                prevPlanEl.style.boxShadow = 'none';
            }
            if (prevCheckEl) prevCheckEl.style.display = 'none';
            
            // Selecionar novo plano
            selectedPaymentPlan = planType;
            selectedPaymentPrice = price;
            
            const planEl = document.getElementById(`plan-${planType}`);
            const checkEl = document.getElementById(`check-${planType}`);
            
            if (planEl) {
                planEl.style.border = '2px solid #ffdb26';
                planEl.style.boxShadow = '0 2px 8px rgba(255, 219, 38, 0.3)';
            }
            if (checkEl) checkEl.style.display = 'block';
            
            // Atualizar valor do pagamento no modal
            updatePaymentAmount();
            
            console.log(`‚úÖ Plano selecionado: ${planType} - R$ ${price.toFixed(2)}`);
        }
        
        // Atualizar valor exibido no modal
        function updatePaymentAmount() {
            const amountEl = document.getElementById('payment-amount');
            if (amountEl) {
                amountEl.textContent = `R$ ${selectedPaymentPrice.toFixed(2).replace('.', ',')}`;
            }
        }
        
        // Inicializar planos de pagamento (Acesso Completo selecionado por padr√£o)
        function initPaymentPlans() {
            selectedPaymentPlan = 'full';
            selectedPaymentPrice = 19.90;
            
            // Garantir que o plano completo est√° selecionado visualmente
            const fullPlanEl = document.getElementById('plan-full');
            const fullCheckEl = document.getElementById('check-full');
            const singlePlanEl = document.getElementById('plan-single');
            const singleCheckEl = document.getElementById('check-single');
            
            if (fullPlanEl) {
                fullPlanEl.style.border = '2px solid #ffdb26';
                fullPlanEl.style.boxShadow = '0 2px 8px rgba(255, 219, 38, 0.3)';
            }
            if (fullCheckEl) fullCheckEl.style.display = 'block';
            
            if (singlePlanEl) {
                singlePlanEl.style.border = '1px solid #ddd';
                singlePlanEl.style.boxShadow = 'none';
            }
            if (singleCheckEl) singleCheckEl.style.display = 'none';
            
            // Atualizar valor para o padr√£o (R$ 19,90)
            updatePaymentAmount();
        }
        
        // Inicializar
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ DOM carregado, iniciando carregamento...');
            loadMangaPages().catch(error => {
                console.error('‚ùå Erro fatal ao carregar p√°ginas:', error);
            });
        });
        
        // Fechar modal ao clicar fora (j√° est√° no onclick do modal-bg)
    </script>
</body>
</html>
